<header>
	{% load static %}
	<script type="text/javascript" src="{% static 'js/jquery-3.1.1.min.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/search-bar.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/pageidx.js' %}"></script>
	<script type="text/javascript" src="{% static 'bootstrap-3.3.7/js/bootstrap.js' %}"></script>
	<link href="{% static 'bootstrap-3.3.7/css/bootstrap.css' %}" rel="stylesheet">
	<script>
		var timer
		var originalSrc
		function getAttr(element, attr, defValue) {
			var value = element.attr(attr)
			if( !value ) {
				return defValue
			}
			return value
		}

		function startFlip(element, template, interval, next, start, end) {
			if(next > end) {
				next = start
			}
			var imgSrc = template.replace(/{index}/, next + "")
			element.attr("src", imgSrc)
			timer = setTimeout(startFlip.bind(null, element, template, interval, next+1, start, end), interval)
		}

		function stopFlip(element, imgSrc) {
			clearTimeout(timer)
			element.attr("src", imgSrc)
		}

		$(document).ready( function(){
		    $("#sug-list").hide()

			// Update nav link of current page to primary
		    $("#nav-list li a").each(function(){
		    	if($(this).attr("href") == window.location.pathname) {
		    		$(this).addClass("btn-primary")
		    	}
		    });

		    $("img.flip").mouseover(function(){
		    	var flipTemplate = $(this).attr("flip-template");
		    	if( flipTemplate ) {
		    		console.log(flipTemplate);
		    	}
		    	var flipInterval = getAttr($(this), "flip-interval", 800)
		    	var flipStart = getAttr($(this), "flip-start", 1)
		    	var flipEnd = getAttr($(this), "flip-end", 16)
		    	originalSrc = $(this).attr("src")
		    	timer = setTimeout(startFlip.bind(null, $(this), flipTemplate, flipInterval, flipStart, flipStart, flipEnd), 1000)
		    });

		    $("img.flip").mouseleave(function(){
				console.log("Left img")
				stopFlip($(this), originalSrc)
		    });

			$("#search_button").click(function(){
			  search( $("#keyword_input").val() )
			})

            $("#keyword_input").focus(function(){
                showSuggestion()
            })

			$("#keyword_input").keyup(function(event){
				showSuggestion()
			})

			$("#keyword_input").focus(function(){
			    showSuggestion()
			})

			$(document).click(function(e){
			 e = window.event || e; // 兼容IE7
			 obj = $(e.srcElement || e.target);
			    if ($(obj).is("#sug-list,#sug-list *,#keyword_input")) {
			   } else {
			   	$("#sug-list").hide()
			 }
			});

			$('#keyword_input').bind('keypress',function(event){
	            if(event.keyCode == "13")
    	        {
        	        search($(this).val())
            	}
        	})
		});

function showSuggestionList(keywords) {
    if(keywords.length == 0) return

    var ul = $("#sug-list")
    ul.empty()
    for (var i = keywords.length - 1; i >= 0; i--) {
        li = document.createElement("li")
            a = document.createElement("a")
            a.href = getLocation(keywords[i],0)
            a.innerHTML = keywords[i]
            li.append(a)
        ul.append(li)
    }
    $("#sug-list").show()
}

function showSuggestion() {
    var keyword = document.getElementById("keyword_input").value

    keyword = processKeyword(keyword)

    if(keyword.length == 0) {
        var historyKeywords = getCookie("history-keywords")
        if(historyKeywords.length > 0){
            keywords = historyKeywords.split("##")

            showSuggestionList(keywords)
        }
    }else{
		$.post("{% url 'keyword_suggest' %}", { 'keyword':keyword, 'csrfmiddlewaretoken': getCookie('csrftoken')},
			function(data,status){
			if(status == "success"){
				var keywords = data['keywords']
				showSuggestionList(keywords)
			}
		})
    }

}

function search(keyword) {

    if(typeof keyword == "undefined" || keyword==null){
        keyword = $("#keyword_input").val()
    }

	keyword = processKeyword(keyword)

    if(keyword.length == 0 || keyword == " ") return false

    //Add it to cookie if it does not exist
    addHistoryKeyword(keyword)

    $("#keyword_input").blur()
    $("#sug-list").hide()

	window.location.href = getLocation(keyword, 0)
}

function processKeyword(keyword){
	keyword = keyword.toLowerCase()
    keyword = keyword.replace(/\s+/, ' ')
    keyword = keyword.replace(/&/,'')

    return keyword
}

function getLocation(keyword, pageIndex) {
	return "{% url 'search' %}" + "?&keyword=" + keyword + "&idx=" + pageIndex
}

function durationStringFromSeconds(seconds) {
	var duration = ""

	var sec = seconds % 60
	var min = parseInt(seconds / 60)
	var hour = 0
	if (min >= 60) {
		hour = parseInt(min / 60)
		min %= 60

		duration += hour
	 }

	duration = duration + ((hour>0)? ":" : "") +((min<10)? "0" : "") + min + ":" + ((sec<10)? "0" :"") + sec

	return duration
}



	</script>
	<style>
        @media (max-width:767px){
            .container{
                width:100%;
            }
        }
        @media (min-width:768px){
            .container{
                margin-left:30px;
                margin-right:30px;
            }
        }
        .container{
            margin-top:0;
        }
        .body-container{
        	background-color: #F1F1F1;
        }

        .navbar{
        	background-color: #FFF;
        }

        a{
        	color: #000;
        }

		#nav-list>li>a{
		    font-family: Oswald Regular,Arial,sans-serif;
    		font-size: 1.6rem;
		}

        li>a:hover, li>a:focus {
        	color: #DF4135;
        }

        body{
        	background-color: #F1F1F1;
        }

        .btn-primary, .btn-primary:focus, .btn-primary:hover{
        	color: #FFF;
        	background-color: #DF4738 !important;
        }

        #sug-list{
        	z-index:5; width:100%;position:absolute;color:000;top:36px;background-color: #fff;list-style-type: none;padding: 0;padding-left: 5px;margin: 0;border: 1px solid #ccc;border-top: none;display: block;
        }

        li{
      		list-style-type:none;
    	}


	</style>
	<!-- navbar -->
	<nav class="navbar nav-default">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed btn btn-default" data-toggle="collapse"
						data-target="#navbar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="glyphicon glyphicon-menu-hamburger" style="color:#337ab7;"></span>
				</button>

				<div class="input-group" style="margin-top:15px;max-width:400px;">
        <span class="input-group-addon" id="search_button">
          <span class="glyphicon glyphicon-search"></span>
        </span>
					<input id="keyword_input" class="form-control" type="search" placeholder="Search Keywords">
					<ul id="sug-list"
						style="">
					</ul>
				</div>
			</div>

			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="navbar-collapse">
				<ul class="nav navbar-nav navbar-right" id="nav-list">
					<li class="active"><a href="{% url 'video-index' %}">Videos</a></li>
					<li><a href="{% url 'live-index' %}">Live</a></li>
					{% if request.user.is_authenticated %}
					<li><a href="{% url 'manage:index' %}">Manage</a></li>
					<li><a href="{% url 'manage:import' %}">Import</a></li>
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-labelledby="user-menu"
						   role="button" aria-haspopup="true" aria-expanded="false">{{ request.user.username }} <span
								class="caret"></span></a>
						<ul class="dropdown-menu" role="menu" id="user-menu">
							<li><a href="#">Info</a></li>
							<li><a href="#">Settings</a></li>
							<li role="separator" class="divider"></li>
							<li><a href="{% url 'admin:logout' %}">Log out</a></li>
						</ul>
					</li>
					{% else %}
					<li><a href="{% url 'admin:login' %}?next={{ request.path }}">Log in</a></li>
					<li><a href="{% url 'admin:logout' %}?next=/">Sign up</a></li>
					{% endif %}
				</ul>
			</div><!-- /.navbar-collapse -->

		</div><!-- /.container-fluid -->
	</nav>

</header>
